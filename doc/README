########################
DESCRIZIONE DEL PROGETTO
########################
Si vuole realizzare un database dei soci dell'osservatorio copernico. Pertanto si decide che:
. Ogni persona inserita nel database (sia che abbia o meno la tessera) costituisce un'identità
. Se un'identità ha la tessera (come accade sempre quando viene iscritto) è anche un socio: quindi un socio è anche un'identità mentre un'identità non è detto che sia anche un socio
. il diritto di socio scade dopo un anno solare (31/12) mentre l'essere un'identita' scade dopo 5 anni consecutivi di mancato rinnovo tessera.

Inoltre:
. Si vuole una stampa di tutti i soci nell'anno corrente in un foglio elettronico
. Alla fine di ogni anno solare verrà meno il diritto di socio ma non verrà cancellata la sua anagrafica dal database
. I soci devono poter essere collegati (ad esempio da legami di parentela)

*****
MYSQL
*****
-- Si decide di implementare un database di nome "soci" con le seguenti tabelle:
1. Tabella "anagrafica" con i seguenti campi
	"member_id": discrimina univocamente un'identità
	"cognome"
	"nome"
	"data_nascita"
	"luogo_nascita"
	"sesso"
	"cf"
	"indirizzo"
	"cap"
	"citta"
	"provincia": serve sapere la regione per l'implementazione del calcolo automatico cf
	"stato"
	"telefono"
	"email": utile per eventuali comunicazioni
	"tessera": questo numero varierà da un anno all'altro relativamente al momento del nuovo tesseramento
	"scadenza": avrà valore +5 rispetto l'ultimo anno di tesseramento (es tesseramento 2016 => 2021)
	
2. Tabella "presenze" con i seguenti campi:
	"data"
	"iscrizione"
	"member_id"
	
3. Tabella "collegamenti" con i seguenti campi:
	"tipo": padre, nonna, compagna, ecc
	"member_id_rel"
	"member_id"
	
***************Per il momento non la implemento*********
4. Tabella "eventi" con i seguenti campi:
	"descrizione"
	"quota_integrativa"
	"data": campo di relazione da tabella "presenze"??
********************************************************
	
. Come engine utilizzo quello di default per la versione di MySql che ho installato (5.6.20) ovvero InnoDB
. Creo l'utente copernico con pieni diritti sul database soci
. Creo la procedura "reset_members" che elimina tutti i soci.
	.. mysql>CALL reset_members(); come azione:
    .. Mette NULL nel campo "data" della tabella "presenze"
    .. Mette NULL nel campo "tessera" della tabella "anagrafica"
	.. Questo file deve essere lanciato assolutamente prima dell'inserimento del primo socio nel nuovo anno
	.. Non è necessario il riavvio del server mysql ma occorre chiudere e riaprire firefox per azzerare i contatori soci
. Creo la procedura "expire_identities" che elimina definitivamente dal database le identità che non diventano più soci per 5 anni consecutivi
	.. mysql>CALL expire_identities(FALSE); mostra quali identità vengono eliminate definitivamente dal database, ma non elimina nulla. 
	.. mysql>CALL expire_identities(TRUE); eliminà tali identità !
	.. Dopo l'eliminazione è necessario riavviare il server mysql ed occorre chiudere e riaprire firefox per azzerare i contatori soci
. Creo la procedura "find_duplicates" che elimina eventuali soci duplicati che vengono erroneamente inserite. In pratica invece di aggiornare un'identità che già esiste, erroneamente si inserisce un nuovo socio, e quindi una nuova identità che a quel punto si duplica
	.. mysql>CALL find_duplicates(FALSE); mostra quali identità sono duplicate, ma non elimina nulla. 
	.. mysql>CALL find_duplicates(TRUE); eliminà le identità duplicate che hanno member_id più alto trasferendfo numero tessera e data tessera in quelli con member_id più basso
	.. Non è necessario il riavvio del server mysql.

		
Nella cartella mysql sono presenti questi file:
. init_database.bat: se lanciato inizializza un nuovo database (tabelle e procedure)
. reset_members.proc.bat: aggiorna la procedura "reset_members" in caso dovesse essere modificata
. expire_identities.proc.bat: aggiorna la procedura "expire_identities" in caso dovesse essere modificata
. XXXX-ELENCO_SOCI.csv: se esiste è l'estrazione dei soci per l'anno XXXX


#################
INSTALLAZIONE GIT
#################
E' indispensabile per il funzionamento degli aggiornamenti
. Lanciare il file GitPortable_X.X.X.paf.exe (le X rappresentano il numero di versione) per installare la versione portabile di Git
. Assicurarsi che il file venga scompattato nella directory del software (D:\dati\xampp\htdocs\soci\): verrà creata la cartella D:\dati\xampp\htdocs\soci\GitPortable


##############################################
INIZIALIZZAZIONE DEL SISTEMA PER UN NUOVO ANNO
##############################################
Prima di cominciare un nuovo anno è necessario effettuare quanto segue:
. Fare un backup del database: si veda la sezione BACKUP/RESTORE
. Esportare in due file csv tutti i soci e tutte le identità tramite il programma stesso
. Lanciare le procedure "reset_members" ed "expire_identities" il cui funzionamento è descritto alla sezione precedente


################
BACKUP / RESTORE
################
Per fare il backup di tutto il database, comprese procedure e trigger è possibile agire in due modi:
1. MANUALMENTE:
Portarsi dentro la cartella dei binari mysql e lanciare: mysqldump.exe -u copernico --routines soci > AAAAMMDD_Backup.sql (con AAAA che indica l'anno, MM il mese e GG il giorno in cui si effettua il backup).
Verrà creato il file AAAAMMDD_Backup.sql nella stessa directory dei binari mysql.
Spostare tale file nella cartella doc del software dove sono anche presenti i file csv
2. AUTOMATICAMENTE:
Dal programma cliccare sulla funzionalità "Operazioni sul DB".
Nella finestra che si apre scegliere "Backup database" (selezionato di default)
Cliccare su "Esegui"
Quando apparirà l'cona che conferma il successo dell'operazione significa che il file AAAAMMDD_Backup.sql (con AAAA che indica l'anno, MM il mese e GG il giorno in cui si effettua il backup) è stato creato nella cartella doc del software dove sono anche presenti i file csv

Per fare il restore di tutto il database, comprese procedure e trigger è possibile agire in due modi:
1. MANUALMENTE:
. Assicurarsi che il file di backup (XXXX-backup.sql) sia nella stessa directory dei binari di mysql
. Connettersi a mysql con l'utente che avrà i permessi su quel database: mysql.exe -u copernico
. Nel caso non esistesse, creare il database (senza le tabelle!): create database copernico;
Nel caso non esistesse l'utente copernico occorre consultare la sezione di inizializzazione mysql nel file "Sviluppo web.odt" 
. Fare il logout da mysql, portarsi dentro la cartella dei binari mysql e lanciare il programma:
mysql -u copernico soci < XXXX-backup.sql (con XXXX che indica l'anno in cui si è effettuato il backup).
2. AUTOMATICAMENTE:
Dal programma cliccare sulla funzionalità "Operazioni sul DB".
Nella finestra che si apre scegliere "Ripristino database"
Dal pulsante a fianco "Sfoglia" scegliere un backup che si vuole ripristinare
Cliccare su "Esegui"
Quando apparirà l'cona che conferma il successo dell'operazione ricaricare nuovamente la pagina Home

###################
GESTIONE NEWSLETTER
###################
Il funzionamento della Newsletter è il seguente:
. Per essere iscritti alla newsletter basta inserire un indirizzo email. Viceversa per cancellarsi alla newsletter basterà cancellare l'indirizzo email
. L'invio della email avviene tramite protocollo SMTP autenticato da password con connessione SSL/TSL
. Il corpo della email è una pagina web in html salvata nella cartella html del sito. In essa è contenuta un'immagine con il nome evento.jpg. E' proprio quest'ultima che rappresenta la locandina dell'evento da pubblicizzare viene letta nella cartella doc del sito. Pertanto ad ogni nuovo evento occorre creare un'immagine con il nome evento.jpg e metterla nella cartella doc del sito. A quel punto automaticamente essa viene inserita nel corpo della email
 
Accedendo alla pagina Newsletter il layout si presenta in questo modo:
. Accanto alla scritta ELENCO IDENTITA' ISCRITTE ALLA NEWSLETTER, dentro le parentesi tonde, viene mostrato il numero di identità che sono iscritti alla newsletter
. A fianco sulla destra cliccando sulla busta gialla si invia la newsletter
. Nel campo oggetto dovrà obbligatoriamente essere scritto quello che apparirà come oggetto nella email.
. Nel campo password dovrà obbligatoriamente essere scritta la password per la connessione al server SMTP per l'invio della email. Il lucchetto a lato indica se, al momento in cui si sta digitando la password, quest'ultima appare criptata durante la digitazione(lucchetto chiuso, come di default) oppure la password è visibile(lucchetto aperto). Il lucchetto si apre e si chiude cliccandoci sopra
. Nel campo area di testo è possibile inserire un messaggio personalizzato che apparirà subito prima dell'immagine che pubblicizza l'evento. Potrebbe essere utile nel caso si voglia inviare una nuova email che corregge un errore di un precedente invio
. La tabella mostra le identità a cui sarà inviata la email. Tramite delle caselle di check si possono escludere o includere solo alcune identità

######################
AGGIORNAMENTI SOFTWARE
######################
Il software è in grado di verificare se ci sono aggiornamenti in maniera automatica. Sarà poi l'utente a decidere se e quando installarli.
Per abilitare questa funzione sono necessari i seguenti requisiti:
. L'installazione di GitPortable nella directory del software. Scaricare GitPortable da portableapps e scompattarlo in modo che si crei il path D:\dati\xampp\htdocs\soci\GitPortable
. E' importante che la directory del programma sia un repository git valido e sia settato il repository remoto

Il controllo degli aggiornamenti avviene al primo avvio del programma. Se vi è una connessione internet, dal ramo master locale viene fatto un fetch del ramo master remoto e successivamente vengono confrontate le due hash di HEAD: se sono diverse è segnalata la presenza di aggiornamenti disponibili mediante la presenza di un asterisco tra parentesi tonde alla voce "Aggiornamento sw" nell'elenco delle funzionalità.
Cliccando su tale voce si aprirà un'altra pagina dove sarà presente un pulsante "Esegui" il quale darà inizio allo scaricamento degli aggiornamenti.
Sia in caso di successo che di fallimento verrà richiesto di tornare alla pagina iniziale mediante un link. Non occorre alcun riavvio del programma.

####
TODO
####
. Nella parte di inserimento nuovo socio
    .. controllare che abbia l'età maggiore o uguale ad 8 anni
. Log errori
. Warning nelle query